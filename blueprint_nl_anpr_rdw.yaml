blueprint:
  name: "ğŸ‡³ğŸ‡± NL ANPR â€“ Frigate + RDW voertuiginfo"
  description: >
    Frigate ANPR blueprint for NL vehicles.
    Fetches RDW info dynamically and sends notification + TTS.
  domain: automation

  input:
    frigate_camera:
      name: Frigate camera
      selector:
        entity:
          domain: camera
    notify_device:
      name: Mobile device for notifications
      selector:
        device:
          integration: mobile_app
    speaker:
      name: Optional speaker for TTS
      default: []
      selector:
        entity:
          domain: media_player
    last_plate_helper:
      name: Helper â€“ last plate
      selector:
        entity:
          domain: input_text
    snapshot_helper:
      name: Helper â€“ snapshot URL
      selector:
        entity:
          domain: input_text

trigger:
  - platform: mqtt
    topic: frigate/events

variables:
  after: "{{ trigger.payload_json.after }}"
  before: "{{ trigger.payload_json.before }}"
  camera: "{{ after.camera or before.camera }}"
  label: "{{ after.label or before.label }}"
  event_id: "{{ after.id or before.id }}"
  raw_plate: "{{ after.recognized_license_plate or before.recognized_license_plate }}"
  plate: >-
    {% if raw_plate is list and raw_plate|length > 0 %}
      {{ raw_plate[0] | upper | regex_replace('[^A-Z0-9]', '') }}
    {% elif raw_plate is string %}
      {{ raw_plate | upper | regex_replace('[^A-Z0-9]', '') }}
    {% else %}
      ""
    {% endif %}
  snapshot: "/api/frigate/notifications/{{ event_id }}/snapshot.jpg"
  stored_plate: "{{ states(inputs.last_plate_helper) }}"

condition:
  - condition: template
    value_template: "{{ camera == inputs.frigate_camera }}"
  - condition: template
    value_template: "{{ label in ['car','truck','bus','motorcycle'] }}"
  - condition: template
    value_template: "{{ plate | length >= 4 }}"
  - condition: template
    value_template: "{{ plate != stored_plate }}"

action:
  # Update helpers
  - service: input_text.set_value
    target:
      entity_id: !input last_plate_helper
    data:
      value: "{{ plate }}"

  - service: input_text.set_value
    target:
      entity_id: !input snapshot_helper
    data:
      value: "{{ snapshot }}"

  # Fetch RDW info dynamically
  - service: rest_command.rdw_lookup
    data:
      kenteken: "{{ plate }}"

  # Wait a moment for REST command to finish
  - delay: "2"

  # Send push notification
  - service: notify.mobile_app
    data:
      title: "ğŸš— Voertuig gedetecteerd"
      message: >
        {{ state_attr('sensor.rdw_voertuig','merk') | default('Onbekend') }}
        {{ state_attr('sensor.rdw_voertuig','handelsbenaming') | default('') }}
        ({{ plate }})
        â€“ kleur {{ state_attr('sensor.rdw_voertuig','eerste_kleur') | default('?') }}
        â€“ APK tot {{ state_attr('sensor.rdw_voertuig','vervaldatum_apk') | default('?') }}
      data:
        image: "{{ snapshot }}"

  # Optional TTS
  - if:
      - condition: template
        value_template: "{{ inputs.speaker != [] }}"
    then:
      - service: tts.google_say
        target:
          entity_id: !input speaker
        data:
          message: >
            {{ state_attr('sensor.rdw_voertuig','merk') }}
            {{ state_attr('sensor.rdw_voertuig','handelsbenaming') }}
            gedetecteerd.
